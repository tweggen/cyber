@page "/notebooks/{NotebookId:guid}/entries/{EntryId:guid}"
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using System.Text.RegularExpressions
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer

<PageTitle>Entry Detail</PageTitle>

<h3>Entry Detail</h3>

<a href="/notebooks/@NotebookId" class="btn btn-sm btn-outline-secondary mb-3">Back to Notebook</a>

@if (errorMessage != null)
{
    <div class="alert alert-warning">@errorMessage</div>
}

@if (entryData == null && errorMessage == null)
{
    <p>Loading...</p>
}
else if (entryData != null)
{
    @if (entryData.Entry.Claims.Count > 0 || entryData.Entry.ClaimsStatus != null)
    {
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Claims</strong>
                @if (entryData.Entry.ClaimsStatus != null)
                {
                    <span class="badge @GetClaimsStatusBadgeClass(entryData.Entry.ClaimsStatus)">
                        @entryData.Entry.ClaimsStatus
                    </span>
                }
            </div>
            <div class="card-body p-0">
                @if (entryData.Entry.Claims.Count > 0)
                {
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Claim</th>
                                <th style="width: 120px;">Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var claim in entryData.Entry.Claims)
                            {
                                <tr>
                                    <td>@claim.Text</td>
                                    <td>
                                        <span class="badge @GetConfidenceBadgeClass(claim.Confidence)">
                                            @claim.Confidence.ToString("P0")
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted p-3 mb-0">No claims distilled yet.</p>
                }
            </div>
        </div>
    }

    <div class="card mb-3">
        <div class="card-header">
            <strong>@(entryData.Entry.Topic ?? "Untitled")</strong>
            <span class="text-muted ms-2">@entryData.Entry.ContentType</span>
        </div>
        <div class="card-body">
            <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">@((MarkupString)LinkifyEntryIds(GetContentText(entryData.Entry.Content)))</pre>
        </div>
        <div class="card-footer text-muted">
            <small>
                ID: <code>@entryData.Entry.Id</code> |
                Author: <code>@entryData.Entry.Author[..16]...</code> |
                Sequence: @entryData.Entry.CausalPosition.Sequence |
                Cost: @entryData.Entry.IntegrationCost.CatalogShift.ToString("F4") |
                Created: @entryData.Entry.Created.ToString("u")
            </small>
        </div>
    </div>

    @if (entryData.Entry.RevisionOf != null)
    {
        <p>Revision of: <a href="/notebooks/@NotebookId/entries/@entryData.Entry.RevisionOf">@entryData.Entry.RevisionOf</a></p>
    }

    @if (entryData.Entry.References.Count > 0)
    {
        <h5>References</h5>
        <ul>
            @foreach (var refEntry in entryData.References)
            {
                <li>
                    <a href="/notebooks/@NotebookId/entries/@refEntry.Id">
                        @(refEntry.Topic ?? refEntry.Id.ToString()[..8])
                    </a>
                    <small class="text-muted"> - @refEntry.Created.ToString("u")</small>
                </li>
            }
        </ul>
    }

    @if (entryData.ReferencedBy.Count > 0)
    {
        <h5>Referenced By</h5>
        <ul>
            @foreach (var refBy in entryData.ReferencedBy)
            {
                <li>
                    <a href="/notebooks/@NotebookId/entries/@refBy.Id">
                        @(refBy.Topic ?? refBy.Id.ToString()[..8])
                    </a>
                    <small class="text-muted"> - @refBy.Created.ToString("u")</small>
                </li>
            }
        </ul>
    }

    @if (entryData.Revisions.Count > 0)
    {
        <h5>Revision Chain</h5>
        <ul>
            @foreach (var rev in entryData.Revisions)
            {
                <li>
                    <a href="/notebooks/@NotebookId/entries/@rev.Id">
                        Revision @rev.Created.ToString("u")
                    </a>
                </li>
            }
        </ul>
    }

    @if (entryData.Entry.NeedsReview)
    {
        <div class="alert alert-warning d-flex align-items-center mb-3">
            <strong class="me-2">Friction Alert</strong>
            This entry has high friction (max: @((entryData.Entry.MaxFriction ?? 0).ToString("F3"))) and needs review.
        </div>
    }

    @if (entryData.Entry.Comparisons.Count > 0)
    {
        <div class="card mb-3">
            <div class="card-header">
                <strong>Comparisons</strong>
                <span class="text-muted ms-2">(@entryData.Entry.Comparisons.Count entries compared)</span>
            </div>
            <div class="card-body">
                @foreach (var comp in entryData.Entry.Comparisons)
                {
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <a href="/notebooks/@NotebookId/entries/@comp.ComparedAgainst">
                                <code>@comp.ComparedAgainst.ToString()[..8]...</code>
                            </a>
                            <small class="text-muted">@comp.ComputedAt.ToString("u")</small>
                        </div>
                        <div class="row g-2 mb-1">
                            <div class="col-6">
                                <small class="text-muted">Entropy (novelty)</small>
                                <div class="progress" style="height: 18px;">
                                    <div class="progress-bar bg-info" style="width: @((comp.Entropy * 100).ToString("F0"))%">
                                        @comp.Entropy.ToString("F3")
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Friction (contradiction)</small>
                                <div class="progress" style="height: 18px;">
                                    <div class="progress-bar @GetFrictionBarClass(comp.Friction)" style="width: @(Math.Max(comp.Friction * 100, 2).ToString("F0"))%">
                                        @comp.Friction.ToString("F3")
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (comp.Contradictions.Count > 0)
                        {
                            <details class="mt-1">
                                <summary class="text-danger" style="cursor: pointer;">
                                    <small>@comp.Contradictions.Count contradiction(s)</small>
                                </summary>
                                <ul class="list-unstyled ms-3 mt-1 mb-0">
                                    @foreach (var c in comp.Contradictions)
                                    {
                                        <li class="mb-1">
                                            <small>
                                                <span class="text-muted">Severity: @c.Severity.ToString("F2")</span><br/>
                                                <strong>A:</strong> @c.ClaimA<br/>
                                                <strong>B:</strong> @c.ClaimB
                                            </small>
                                        </li>
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <hr />
    <h5>Revise Entry</h5>

    @if (revisionResult != null)
    {
        <div class="alert alert-success">
            Revision created: <a href="/notebooks/@NotebookId/entries/@revisionResult.RevisionId">View revision</a>
            (Cost: @revisionResult.IntegrationCost.CatalogShift.ToString("F4"))
        </div>
    }

    <EditForm Model="reviseModel" OnValidSubmit="HandleRevise" FormName="reviseEntry">
        <div class="mb-3">
            <label class="form-label">New Content</label>
            <InputTextArea class="form-control" @bind-Value="reviseModel.Content" rows="4" />
        </div>
        <div class="mb-3">
            <label class="form-label">Reason (optional)</label>
            <InputText class="form-control" @bind-Value="reviseModel.Reason" />
        </div>
        <button type="submit" class="btn btn-primary" disabled="@isRevising">
            @(isRevising ? "Revising..." : "Submit Revision")
        </button>
    </EditForm>
}

@code {
    [Parameter] public Guid NotebookId { get; set; }
    [Parameter] public Guid EntryId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private ReadEntryResponse? entryData;
    private string? errorMessage;
    private string? authorIdHex;

    private ReviseFormModel reviseModel = new();
    private ReviseEntryResponse? revisionResult;
    private bool isRevising;

    public class ReviseFormModel
    {
        public string Content { get; set; } = string.Empty;
        public string? Reason { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var state = AuthState != null ? await AuthState : null;
        authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);
        if (authorIdHex == null)
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        try
        {
            entryData = await ApiClient.ReadEntryAsync(authorIdHex, NotebookId, EntryId);
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Could not load entry: {ex.Message}";
        }
    }

    private string GetContentText(object? content)
    {
        if (content == null) return string.Empty;
        // Content can be a string (text) or an object with data+encoding (binary)
        return content.ToString() ?? string.Empty;
    }

    private static readonly Regex UuidRegex = new(
        @"[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}",
        RegexOptions.Compiled);

    private string LinkifyEntryIds(string text)
    {
        var escaped = System.Net.WebUtility.HtmlEncode(text);
        return UuidRegex.Replace(escaped, match =>
        {
            var id = match.Value;
            var href = $"/notebooks/{NotebookId}/entries/{id}";
            return $"<a href=\"{href}\">{id}</a>";
        });
    }

    private static string GetClaimsStatusBadgeClass(string? status) => status switch
    {
        "distilled" => "bg-success",
        "verified" => "bg-primary",
        _ => "bg-secondary",
    };

    private static string GetConfidenceBadgeClass(double confidence) => confidence switch
    {
        >= 0.8 => "bg-success",
        >= 0.5 => "bg-warning text-dark",
        _ => "bg-secondary",
    };

    private static string GetFrictionBarClass(double friction) => friction switch
    {
        >= 0.5 => "bg-danger",
        >= 0.2 => "bg-warning",
        _ => "bg-success",
    };

    private async Task HandleRevise()
    {
        if (authorIdHex == null || string.IsNullOrWhiteSpace(reviseModel.Content)) return;
        isRevising = true;
        errorMessage = null;

        try
        {
            var request = new ReviseEntryRequest
            {
                Content = reviseModel.Content,
                Reason = string.IsNullOrWhiteSpace(reviseModel.Reason) ? null : reviseModel.Reason,
            };
            revisionResult = await ApiClient.ReviseEntryAsync(authorIdHex, NotebookId, EntryId, request);
            reviseModel = new ReviseFormModel();

            // Reload entry data to show updated revision chain
            entryData = await ApiClient.ReadEntryAsync(authorIdHex, NotebookId, EntryId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to revise: {ex.Message}";
        }
        finally
        {
            isRevising = false;
        }
    }
}
