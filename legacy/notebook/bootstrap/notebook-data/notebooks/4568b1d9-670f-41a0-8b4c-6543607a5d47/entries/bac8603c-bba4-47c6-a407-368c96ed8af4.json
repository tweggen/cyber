{
  "id": "bac8603c-bba4-47c6-a407-368c96ed8af4",
  "content": "DECISION 1-1: Storage Layer Implementation Design\n\nAUTHOR: agent-storage\n\nDECISION SUMMARY:\n\nReviewed existing code in notebook-store. The Phase 0 implementation already has most infrastructure in place:\n- Store struct with connection pooling\n- Models for AuthorRow, NotebookRow, EntryRow\n- Input types: NewAuthor, NewNotebook, NewEntry\n- Basic CRUD operations\n- Graph queries via Apache AGE\n\nIMPLEMENTATION APPROACH:\n\n1. REPOSITORY PATTERN: Will create repository.rs to wrap Store with domain-type interfaces. The task specifies function signatures using notebook-core types (EntryId, NotebookId, AuthorId), but current Store uses raw UUID/bytes. Repository will provide the translation layer.\n\n2. FUNCTION MAPPING:\n   - store_entry() -> wraps insert_entry() with NewEntry from notebook_core::Entry\n   - get_entry() -> wraps get_entry(), converts EntryRow to notebook_core::Entry\n   - get_entry_revision() -> NEW: query specific revision by revision chain depth\n   - get_revision_chain() -> wraps get_revisions(), returns Vec<Entry>\n   - get_references() -> NEW: fetch entries referenced by an entry\n   - get_referencing() -> wraps get_entries_referencing(), returns Vec<Entry>\n   - create_notebook() -> wraps insert_notebook()\n   - get_notebook() -> wraps get_notebook(), converts to notebook_core::Notebook\n   - register_author() -> wraps insert_author() with BLAKE3 hash computation for AuthorId\n   - get_author() -> NEW method returning domain Author type\n\n3. CYCLE-SAFE TRAVERSAL:\n   - Use HashSet<EntryId> for visited tracking\n   - Default depth limit: 100 (matching existing SQL)\n   - For get_references: follow Entry.references recursively with depth limit\n   - AGE graph functions already handle cycles via path length limits\n\n4. QUERIES MODULE:\n   - Create queries.rs for specialized query builders\n   - Batch fetching for references (single query with IN clause)\n   - Optional depth parameter for recursive queries\n\n5. CONVERSION LAYER:\n   - EntryRow <-> Entry conversions in repository.rs\n   - Handle CausalPosition construction from sequence + activity_context\n   - AuthorId from 32-byte Vec<u8>\n\nFILES TO CREATE/MODIFY:\n- crates/notebook-store/src/repository.rs (NEW)\n- crates/notebook-store/src/queries.rs (NEW)\n- crates/notebook-store/src/store.rs (extend with helper methods)\n- crates/notebook-store/src/lib.rs (add module exports)\n\nRISKS:\n- AGE graph operations may fail silently (current code logs warnings)\n- Cycle detection in pure SQL needs depth limits\n- Large reference graphs could be expensive\n\nMITIGATIONS:\n- Keep relational queries as fallback when graph fails\n- Configurable depth limits\n- Pagination for large result sets",
  "content_type": "text/plain",
  "topic": "decision 1-1",
  "references": [
    "a52842ba-d286-431c-8364-1f0c0085b111",
    "a533fd75-1485-4602-b9a2-3f9010390ced"
  ],
  "revision_of": null,
  "author": "agent-storage",
  "causal_position": {
    "sequence": 32,
    "activity_context": {
      "entries_since_last_by_author": 0,
      "total_notebook_entries": 31,
      "recent_entropy": 14.3
    }
  },
  "created": "2026-02-05T10:44:43.428664+00:00",
  "integration_cost": {
    "entries_revised": 0,
    "references_broken": 0,
    "catalog_shift": 0.0,
    "orphan": false
  }
}