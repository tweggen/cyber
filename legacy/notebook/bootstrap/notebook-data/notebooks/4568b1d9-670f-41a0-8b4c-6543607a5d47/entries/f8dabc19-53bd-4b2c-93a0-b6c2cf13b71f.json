{
  "id": "f8dabc19-53bd-4b2c-93a0-b6c2cf13b71f",
  "content": "DECISION 0-3: Database Schema Design\n\nDATABASE LIBRARY:\n- Using sqlx (0.8) for type-safe async database access\n- Chose sqlx over diesel for simpler async integration and raw SQL support needed for AGE\n- AGE requires raw cypher queries which sqlx handles better than diesel ORM\n\nMIGRATION STRATEGY:\n- Using sqlx migrations (numbered files: 002_schema.sql, 003_graph.sql)\n- init.sql already enables AGE extension and creates graph (from Task 0-1)\n- Additional migrations create tables and graph schema\n\nSCHEMA DESIGN:\n\n1. authors table:\n   - id: UUID PRIMARY KEY\n   - public_key: BYTEA NOT NULL (Ed25519 public key, 32 bytes)\n   - created: TIMESTAMPTZ NOT NULL DEFAULT NOW()\n   - UNIQUE constraint on public_key\n\n2. notebooks table:\n   - id: UUID PRIMARY KEY  \n   - name: TEXT NOT NULL\n   - owner_id: UUID NOT NULL REFERENCES authors(id)\n   - created: TIMESTAMPTZ NOT NULL DEFAULT NOW()\n\n3. notebook_access table:\n   - notebook_id: UUID REFERENCES notebooks(id) ON DELETE CASCADE\n   - author_id: UUID REFERENCES authors(id) ON DELETE CASCADE\n   - read: BOOLEAN NOT NULL DEFAULT false\n   - write: BOOLEAN NOT NULL DEFAULT false\n   - granted: TIMESTAMPTZ NOT NULL DEFAULT NOW()\n   - PRIMARY KEY (notebook_id, author_id)\n\n4. entries table:\n   - id: UUID PRIMARY KEY\n   - notebook_id: UUID NOT NULL REFERENCES notebooks(id)\n   - content: BYTEA NOT NULL (unified storage for all content types)\n   - content_type: TEXT NOT NULL (MIME type)\n   - topic: TEXT (nullable, for grouping)\n   - author_id: UUID NOT NULL REFERENCES authors(id)\n   - signature: BYTEA NOT NULL (Ed25519 signature, 64 bytes)\n   - revision_of: UUID REFERENCES entries(id) (self-referential)\n   - references: UUID[] NOT NULL DEFAULT ARRAY[]::UUID[] (array of entry IDs)\n   - sequence: BIGINT NOT NULL (per-notebook monotonic)\n   - created: TIMESTAMPTZ NOT NULL DEFAULT NOW()\n   - integration_cost: JSONB NOT NULL (stores IntegrationCost struct)\n\nINDEXES:\n   - btree on (notebook_id, sequence) for ordered retrieval\n   - gin on references for array containment queries\n   - gin with pg_trgm on content for text search (when content_type is text/*)\n   - btree on (notebook_id, topic) for topic filtering\n   - btree on revision_of for revision chain queries\n\nGRAPH SCHEMA:\n   - Vertices: Entry nodes with properties (id, notebook_id, topic, author_id, sequence)\n   - Edges: \n     - \"references\" edge: entry -> referenced_entry\n     - \"revision_of\" edge: new_entry -> old_entry  \n     - \"coherence\" edge: entry <-> related_entry (bidirectional semantic links)\n\nCONTENT STORAGE RATIONALE:\n   - Using BYTEA for content instead of JSONB to handle binary content (images, etc)\n   - Text content stored as UTF-8 bytes, applications decode based on content_type\n   - This aligns with Vec<u8> from task-assignment 0-2\n\nTYPE ALIGNMENT:\n   - integration_cost stored as JSONB matching IntegrationCost struct\n   - causal_position computed at read time (sequence + activity query)\n   - activity_context computed dynamically, not stored\n\nREFERENCES: task-assignment 0-3, task-assignment 0-2, foundation technology",
  "content_type": "text/plain",
  "topic": "decision 0-3",
  "references": [
    "3d6c2da5-e25f-4d73-84ff-ff0cd45ef9d2",
    "013bba92-7e7e-452c-b224-b19240f6bbdd",
    "4841e17c-9c5c-4cbc-9005-c1b519322031"
  ],
  "revision_of": null,
  "author": "agent-store",
  "causal_position": {
    "sequence": 18,
    "activity_context": {
      "entries_since_last_by_author": 0,
      "total_notebook_entries": 17,
      "recent_entropy": 9.5
    }
  },
  "created": "2026-02-05T10:30:48.165020+00:00",
  "integration_cost": {
    "entries_revised": 0,
    "references_broken": 0,
    "catalog_shift": 0.0,
    "orphan": false
  }
}