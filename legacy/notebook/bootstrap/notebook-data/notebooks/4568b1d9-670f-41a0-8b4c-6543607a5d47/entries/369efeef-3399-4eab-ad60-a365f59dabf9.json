{
  "id": "369efeef-3399-4eab-ad60-a365f59dabf9",
  "content": "DECISION 3-4: Catalog Cache Implementation Design\n\nAUTHOR: agent-cache\n\nOVERVIEW:\nImplement an in-memory catalog cache with thread-safe access and intelligent invalidation.\n\nDESIGN DECISIONS:\n\n1. Data Structures:\n   - CatalogCache: Main cache struct using HashMap<NotebookId, CachedCatalog>\n   - CachedCatalog: Wrapper with { catalog: Catalog, cached_at: Instant, cached_at_sequence: u64 }\n   - Thread-safe via Arc<RwLock<HashMap<...>>>\n\n2. Cache Operations:\n   - get(notebook_id) -> Option<CachedCatalog>: Returns cached catalog if exists\n   - set(notebook_id, catalog, sequence): Stores catalog with timestamp\n   - invalidate(notebook_id): Removes entry from cache\n   - invalidate_if_stale(notebook_id, catalog_shift): Conditional invalidation based on shift threshold\n\n3. Invalidation Rules:\n   - CATALOG_SHIFT_THRESHOLD = 0.1: Invalidate if catalog_shift > 0.1\n   - MAX_CACHE_AGE = 300 seconds (5 minutes): Age-based expiration\n   - Both configurable via CacheConfig struct\n\n4. Stale-While-Revalidate Pattern:\n   - is_stale() method returns true if cache should be revalidated\n   - get() still returns stale entries (caller decides to use or not)\n   - CacheStatus enum: Fresh, Stale, StaleRevalidating\n   - Caller can serve stale and trigger background regeneration\n\n5. Thread Safety:\n   - RwLock allows concurrent reads with exclusive writes\n   - Clone-able via Arc for sharing across threads\n   - All public methods take &self (interior mutability)\n\n6. Configuration:\n   - CacheConfig { shift_threshold: f64, max_age_secs: u64 }\n   - CacheConfig::default() uses 0.1 threshold, 300s max age\n   - CatalogCache::with_config() for custom settings\n\nIMPLEMENTATION PLAN:\n1. Define CacheConfig, CachedCatalog, CacheStatus types\n2. Implement CatalogCache with HashMap<NotebookId, CachedCatalog>\n3. Add get/set/invalidate/invalidate_if_stale methods\n4. Add is_stale/is_expired helper methods\n5. Unit tests for all operations\n6. Export from lib.rs\n\nFILE STRUCTURE:\n- crates/notebook-entropy/src/cache.rs (new file)\n- crates/notebook-entropy/src/lib.rs (add export)",
  "content_type": "text/plain",
  "topic": "decision 3-4",
  "references": [
    "ca39b92f-5801-4555-ad50-877e160e9483",
    "5a35dc51-b312-41d0-b887-3c466d3d4a7c"
  ],
  "revision_of": null,
  "author": "agent-cache",
  "causal_position": {
    "sequence": 84,
    "activity_context": {
      "entries_since_last_by_author": 0,
      "total_notebook_entries": 83,
      "recent_entropy": 52.4
    }
  },
  "created": "2026-02-05T15:09:43.648136+00:00",
  "integration_cost": {
    "entries_revised": 0,
    "references_broken": 0,
    "catalog_shift": 0.0,
    "orphan": false
  }
}