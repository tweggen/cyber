@page "/auth/register"
@using Microsoft.AspNetCore.Identity
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject AuthorService AuthorService
@inject NavigationManager Navigation

<PageTitle>Register</PageTitle>

<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <h3>Register</h3>

        @if (errors.Count > 0)
        {
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach (var error in errors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
        }

        <EditForm Model="registerModel" OnValidSubmit="HandleRegister" FormName="register">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <InputText id="username" class="form-control" @bind-Value="registerModel.Username" />
            </div>

            <div class="mb-3">
                <label for="displayName" class="form-label">Display Name (optional)</label>
                <InputText id="displayName" class="form-control" @bind-Value="registerModel.DisplayName" />
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <InputText id="password" type="password" class="form-control" @bind-Value="registerModel.Password" />
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="registerModel.ConfirmPassword" />
            </div>

            <button type="submit" class="btn btn-primary w-100">Register</button>
        </EditForm>

        <p class="mt-3 text-center">
            Already have an account? <a href="/auth/login">Login</a>
        </p>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private RegisterModel registerModel { get; set; } = new();

    private List<string> errors = [];

    private async Task HandleRegister()
    {
        errors.Clear();

        if (registerModel.Password != registerModel.ConfirmPassword)
        {
            errors.Add("Passwords do not match.");
            return;
        }

        // Register author with the notebook API
        var (authorIdHex, authorIdBytes) = await AuthorService.RegisterNewAuthorAsync();

        var user = new ApplicationUser
        {
            UserName = registerModel.Username,
            DisplayName = registerModel.DisplayName,
            AuthorId = authorIdBytes,
            AuthorIdHex = authorIdHex,
        };

        var result = await UserManager.CreateAsync(user, registerModel.Password);

        if (result.Succeeded)
        {
            await SignInManager.SignInAsync(user, isPersistent: true);
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            errors.AddRange(result.Errors.Select(e => e.Description));
        }
    }

    private class RegisterModel
    {
        public string Username { get; set; } = string.Empty;
        public string? DisplayName { get; set; }
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
