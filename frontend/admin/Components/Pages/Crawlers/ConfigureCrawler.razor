@page "/crawlers/configure"
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@using System.Text.Json
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Configure Crawler</PageTitle>

<h3>Configure Confluence Crawler</h3>

<div class="card mb-4">
    <div class="card-body">
        @if (errorMessage != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        @if (successMessage != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        <!-- Notebook Selector -->
        <div class="mb-3">
            <label class="form-label">Select Notebook</label>
            <div class="d-flex gap-2">
                <select class="form-select" @bind="selectedNotebookId" disabled="@isLoading">
                    <option value="">-- Select a notebook --</option>
                    @if (notebooks != null)
                    {
                        @foreach (var nb in notebooks)
                        {
                            <option value="@nb.Id">@nb.Name</option>
                        }
                    }
                </select>
                <button class="btn btn-outline-secondary" @onclick="LoadCrawlerConfig" disabled="@(selectedNotebookId == Guid.Empty || isLoading)">
                    @(isLoading ? "Loading..." : "Load")
                </button>
            </div>
        </div>

        <!-- Status Display -->
        @if (selectedNotebookId != Guid.Empty && crawlerConfig != null)
        {
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <span class="badge @(crawlerConfig.IsEnabled ? "bg-success" : "bg-secondary")">
                            @(crawlerConfig.IsEnabled ? "Enabled" : "Disabled")
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>Last Sync:</strong>
                        @if (crawlerConfig.LastSyncAt.HasValue)
                        {
                            <span>@crawlerConfig.LastSyncAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</span>
                            <span class="badge @GetSyncStatusBadgeClass()">@crawlerConfig.LastSyncStatus</span>
                        }
                        else
                        {
                            <span class="text-muted">Never</span>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Configuration JSON Editor -->
        <div class="mb-3">
            <label class="form-label">Configuration JSON</label>
            <textarea class="form-control" rows="15" @bind="configJson"
                      style="font-family: monospace; font-size: 12px;"
                      placeholder="Paste or edit your Confluence crawler configuration here..."
                      disabled="@isSubmitting"></textarea>
            <small class="text-muted d-block mt-1">Monospace font for JSON editing</small>
        </div>

        <!-- Example Configuration Collapsible -->
        <div class="mb-3">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                    data-bs-target="#exampleConfig" aria-expanded="false" aria-controls="exampleConfig">
                Show Example Configuration
            </button>
            <div class="collapse mt-2" id="exampleConfig">
                <div class="card card-body bg-light">
                    <pre style="margin: 0; font-size: 11px;"><code>{
  "base_url": "https://company.atlassian.net/wiki",
  "username": "user@company.com",
  "api_token": "ATATT3xFfGF0...",
  "space_key": "ENG",
  "include_labels": [],
  "exclude_labels": ["draft"],
  "max_pages": 0,
  "include_attachments": false
}</code></pre>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mb-3">
            <button class="btn btn-primary" @onclick="SaveConfiguration"
                    disabled="@(!IsConfigValid() || isSubmitting || selectedNotebookId == Guid.Empty)">
                @(isSubmitting ? "Saving..." : "Save Configuration")
            </button>
            <button class="btn btn-info ms-2" @onclick="TestConnection"
                    disabled="@(!IsConfigValid() || isSubmitting)">
                @(isSubmitting ? "Testing..." : "Test Connection")
            </button>
            <button class="btn btn-success ms-2" @onclick="RunCrawler"
                    disabled="@(selectedNotebookId == Guid.Empty || isSubmitting)">
                @(isSubmitting ? "Running..." : "Run Now")
            </button>
        </div>

        <!-- Test Result -->
        @if (testResult != null)
        {
            <div class="alert @(testResult.Success ? "alert-success" : "alert-warning") mt-3">
                <strong>Test Result:</strong> @testResult.Message
                @if (testResult.Error != null)
                {
                    <div class="mt-2">
                        <strong>Error:</strong> @testResult.Error
                    </div>
                }
                @if (testResult.SpaceInfo != null)
                {
                    <div class="mt-2">
                        <strong>Space Info:</strong>
                        <pre style="background: #f0f0f0; padding: 8px; border-radius: 4px; font-size: 11px; margin: 0;">@JsonSerializer.Serialize(testResult.SpaceInfo, new JsonSerializerOptions { WriteIndented = true })</pre>
                    </div>
                }
            </div>
        }

        <!-- Run Result -->
        @if (runResult != null)
        {
            <div class="alert @(runResult.Success ? "alert-success" : "alert-warning") mt-3">
                <strong>Run Result:</strong> @runResult.Message
                @if (!runResult.Success && runResult.Error != null)
                {
                    <div class="mt-2">
                        <strong>Error:</strong> @runResult.Error
                    </div>
                }
                else if (runResult.Success)
                {
                    <div class="mt-2">
                        <p><strong>Entries Created:</strong> @runResult.EntriesCreated</p>
                        <p><strong>Duration:</strong> @runResult.Duration.ToString("F2")s</p>
                        @if (runResult.RunId.HasValue)
                        {
                            <p><strong>Run ID:</strong> <code>@runResult.RunId.Value.ToString().Substring(0, 8)</code></p>
                            <a href="/crawlers/@selectedNotebookId/runs" class="btn btn-sm btn-outline-primary">View Run History</a>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private Guid selectedNotebookId = Guid.Empty;
    private string? configJson;
    private string? errorMessage;
    private string? successMessage;
    private bool isSubmitting = false;
    private bool isLoading = false;
    private List<NotebookSummary>? notebooks;
    private CrawlerConfigResponse? crawlerConfig;
    private CrawlerTestResponse? testResult;
    private CrawlerRunResponse? runResult;
    private Task<AuthenticationState>? AuthState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = AuthState != null ? await AuthState : null;
            var authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);

            if (authorIdHex == null)
            {
                Navigation.NavigateTo("/auth/login");
                return;
            }

            isLoading = true;
            var response = await ApiClient.ListNotebooksAsync(authorIdHex);
            notebooks = response?.Notebooks;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load notebooks: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCrawlerConfig()
    {
        try
        {
            testResult = null;
            runResult = null;
            errorMessage = null;
            successMessage = null;

            if (selectedNotebookId == Guid.Empty)
            {
                configJson = null;
                crawlerConfig = null;
                return;
            }

            var state = AuthState != null ? await AuthState : null;
            var authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);

            isLoading = true;
            crawlerConfig = await ApiClient.GetCrawlerConfigAsync(authorIdHex!, selectedNotebookId);

            if (crawlerConfig != null && crawlerConfig.ConfigJson != null)
            {
                configJson = crawlerConfig.ConfigJson;
            }
            else
            {
                configJson = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load crawler configuration: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveConfiguration()
    {
        try
        {
            if (!IsConfigValid())
            {
                errorMessage = "Invalid JSON configuration";
                return;
            }

            var state = AuthState != null ? await AuthState : null;
            var authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);

            isSubmitting = true;
            var response = await ApiClient.ConfigureConfluenceCrawlerAsync(authorIdHex!, selectedNotebookId, configJson!);

            if (response != null && response.Success)
            {
                successMessage = "Configuration saved successfully!";
                crawlerConfig = response;
            }
            else
            {
                errorMessage = response?.Error ?? "Failed to save configuration";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving configuration: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task TestConnection()
    {
        try
        {
            if (!IsConfigValid())
            {
                errorMessage = "Invalid JSON configuration";
                return;
            }

            var state = AuthState != null ? await AuthState : null;
            var authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);

            isSubmitting = true;
            testResult = await ApiClient.TestConfluenceCrawlerAsync(authorIdHex!, configJson!);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error testing connection: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task RunCrawler()
    {
        try
        {
            var state = AuthState != null ? await AuthState : null;
            var authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);

            isSubmitting = true;
            runResult = await ApiClient.RunConfluenceCrawlerAsync(authorIdHex!, selectedNotebookId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error running crawler: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private bool IsConfigValid()
    {
        if (string.IsNullOrWhiteSpace(configJson))
            return false;

        try
        {
            JsonSerializer.Deserialize<JsonElement>(configJson);
            return true;
        }
        catch
        {
            return false;
        }
    }

    private string GetSyncStatusBadgeClass()
    {
        return crawlerConfig?.LastSyncStatus switch
        {
            "success" => "bg-success",
            "failed" => "bg-danger",
            "running" => "bg-primary",
            _ => "bg-secondary"
        };
    }
}
