@page "/notebooks"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation
@inject TokenService TokenService
@inject IConfiguration Configuration
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Notebooks</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Notebooks</h3>
    <button class="btn btn-primary" @onclick="ShowCreateForm" disabled="@isCreating">New Notebook</button>
</div>

@if (showCreateForm)
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex gap-2">
                <input type="text" class="form-control" placeholder="Notebook name"
                       @bind="newNotebookName" @bind:event="oninput" />
                <button class="btn btn-primary" @onclick="CreateNotebook"
                        disabled="@(isCreating || string.IsNullOrWhiteSpace(newNotebookName))">Create</button>
                <button class="btn btn-outline-secondary" @onclick="CancelCreate"
                        disabled="@isCreating">Cancel</button>
            </div>
            @if (createError != null)
            {
                <div class="text-danger mt-2">@createError</div>
            }
        </div>
    </div>
}

@if (errorMessage != null)
{
    <div class="alert alert-warning">@errorMessage</div>
}

@if (notebooks == null && errorMessage == null)
{
    <p>Loading...</p>
}
else if (notebooks != null)
{
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>Name</th>
                <th>Entries</th>
                <th>Entropy</th>
                <th>Participants</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var nb in notebooks.OrderBy(n => n.Name, StringComparer.OrdinalIgnoreCase))
            {
                <tr>
                    <td>
                        @if (renamingNotebookId == nb.Id)
                        {
                            <div class="d-flex gap-1">
                                <input type="text" class="form-control form-control-sm"
                                       @bind="renameValue" @bind:event="oninput"
                                       @onkeydown="HandleRenameKeyDown" />
                                <button class="btn btn-sm btn-primary" @onclick="ConfirmRename"
                                        disabled="@(isRenaming || string.IsNullOrWhiteSpace(renameValue))">Save</button>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelRename"
                                        disabled="@isRenaming">Cancel</button>
                            </div>
                            @if (renameError != null)
                            {
                                <div class="text-danger small mt-1">@renameError</div>
                            }
                        }
                        else
                        {
                            <a href="/notebooks/@nb.Id">@nb.Name</a>
                        }
                    </td>
                    <td>@nb.TotalEntries</td>
                    <td>@nb.TotalEntropy.ToString("F2")</td>
                    <td>@nb.ParticipantCount</td>
                    <td>
                        <a href="/notebooks/@nb.Id" class="btn btn-sm btn-outline-primary">View</a>
                        @if (nb.IsOwner)
                        {
                            <button class="btn btn-sm btn-outline-secondary ms-1"
                                    @onclick="() => StartRename(nb)"
                                    disabled="@(renamingNotebookId != null || deletingNotebookId != null)">Rename</button>

                            @if (deletingNotebookId == nb.Id)
                            {
                                <span class="ms-1">
                                    <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(nb.Id)"
                                            disabled="@isDeleting">Yes, Delete</button>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="CancelDelete"
                                            disabled="@isDeleting">Cancel</button>
                                </span>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-danger ms-1"
                                        @onclick="() => StartDelete(nb.Id)"
                                        disabled="@(renamingNotebookId != null || deletingNotebookId != null)">Delete</button>
                            }
                            <button class="btn btn-sm btn-outline-info ms-1"
                                    @onclick="() => ShowConnect(nb)"
                                    disabled="@(renamingNotebookId != null || deletingNotebookId != null)">Connect</button>
                            <button class="btn btn-sm btn-outline-warning ms-1"
                                    @onclick="() => ShowToken(nb)"
                                    disabled="@(renamingNotebookId != null || deletingNotebookId != null)">Token</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (connectNotebookId != null)
    {
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span>Connect <strong>@connectNotebookName</strong> to</span>
                    <select class="form-select form-select-sm" style="width: auto;"
                            @onchange="OnTargetChanged" value="@connectTarget">
                        @foreach (var kv in TargetLabels)
                        {
                            <option value="@kv.Key">@kv.Value</option>
                        }
                    </select>
                </div>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CloseConnect">Close</button>
            </div>
            <div class="card-body">
                <p class="text-muted small">Run one of these commands to register the notebook MCP server:</p>

                <div class="mb-3">
                    <label class="form-label small fw-bold mb-1">Bash (Mac / Linux / WSL)</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control font-monospace" value="@bashCommand" readonly />
                        <button class="btn btn-outline-secondary"
                                onclick="clipboardCopyFromSibling(this)"
                                title="Copy to clipboard">Copy</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold mb-1">Git Bash (Windows)</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control font-monospace" value="@gitBashCommand" readonly />
                        <button class="btn btn-outline-secondary"
                                onclick="clipboardCopyFromSibling(this)"
                                title="Copy to clipboard">Copy</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold mb-1">PowerShell (Windows)</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control font-monospace" value="@psCommand" readonly />
                        <button class="btn btn-outline-secondary"
                                onclick="clipboardCopyFromSibling(this)"
                                title="Copy to clipboard">Copy</button>
                    </div>
                </div>

                <p class="text-muted small mb-0">
                    Token is short-lived. Click <strong>Connect</strong> again to generate a fresh command.
                </p>
            </div>
        </div>
    }

    @if (tokenNotebookId != null)
    {
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Token for <strong>@tokenNotebookName</strong></span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CloseToken">Close</button>
            </div>
            <div class="card-body">
                <label class="text-muted small mb-1">Notebook ID</label>
                <div class="input-group input-group-sm mb-3">
                    <input type="text" class="form-control font-monospace" value="@tokenNotebookId" readonly />
                    <button class="btn btn-outline-secondary"
                            onclick="clipboardCopyFromSibling(this)"
                            title="Copy to clipboard">Copy</button>
                </div>

                <label class="text-muted small mb-1">JWT Token</label>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control font-monospace" value="@tokenValue" readonly />
                    <button class="btn btn-outline-secondary"
                            onclick="clipboardCopyFromSibling(this)"
                            title="Copy to clipboard">Copy</button>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    Token is short-lived. Click <strong>Token</strong> again to generate a fresh one.
                </p>
            </div>
        </div>
    }

    @if (notebooks.Count == 0)
    {
        <p class="text-muted">No notebooks found. The notebook API may be unreachable or no notebooks have been created.</p>
    }
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private List<NotebookSummary>? notebooks;
    private string? errorMessage;
    private bool showCreateForm;
    private string? newNotebookName;
    private bool isCreating;
    private string? createError;
    private string? authorId;

    // Rename state
    private Guid? renamingNotebookId;
    private string? renameValue;
    private bool isRenaming;
    private string? renameError;

    // Delete state
    private Guid? deletingNotebookId;
    private bool isDeleting;

    // Connect state
    private Guid? connectNotebookId;
    private string? connectNotebookName;
    private string? connectToken;
    private string connectTarget = "claude";
    private string? bashCommand;
    private string? gitBashCommand;
    private string? psCommand;

    // Token state
    private Guid? tokenNotebookId;
    private string? tokenNotebookName;
    private string? tokenValue;

    private static readonly Dictionary<string, string> TargetLabels = new()
    {
        ["claude"] = "Claude Code",
        ["cursor"] = "Cursor",
    };

    private string McpType => Configuration["NotebookApi:McpType"] ?? "notebook";


    protected override async Task OnInitializedAsync()
    {
        var state = AuthState != null ? await AuthState : null;
        authorId = await CurrentUser.GetAuthorIdHexAsync(state?.User);
        if (authorId == null)
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        try
        {
            var response = await ApiClient.ListNotebooksAsync(authorId);
            notebooks = response?.Notebooks ?? [];
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Could not connect to notebook API: {ex.Message}";
        }
    }

    // ===== Create =====

    private void ShowCreateForm()
    {
        showCreateForm = true;
        newNotebookName = null;
        createError = null;
    }

    private void CancelCreate()
    {
        showCreateForm = false;
        newNotebookName = null;
        createError = null;
    }

    private async Task CreateNotebook()
    {
        if (string.IsNullOrWhiteSpace(newNotebookName) || authorId == null)
            return;

        isCreating = true;
        createError = null;

        try
        {
            await ApiClient.CreateNotebookAsync(authorId, newNotebookName.Trim());
            showCreateForm = false;
            newNotebookName = null;

            // Reload the list
            var response = await ApiClient.ListNotebooksAsync(authorId);
            notebooks = response?.Notebooks ?? [];
        }
        catch (HttpRequestException ex)
        {
            createError = $"Failed to create notebook: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }

    // ===== Rename =====

    private void StartRename(NotebookSummary nb)
    {
        renamingNotebookId = nb.Id;
        renameValue = nb.Name;
        renameError = null;
    }

    private void CancelRename()
    {
        renamingNotebookId = null;
        renameValue = null;
        renameError = null;
    }

    private async Task HandleRenameKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await ConfirmRename();
        else if (e.Key == "Escape")
            CancelRename();
    }

    private async Task ConfirmRename()
    {
        if (renamingNotebookId == null || string.IsNullOrWhiteSpace(renameValue) || authorId == null)
            return;

        isRenaming = true;
        renameError = null;

        try
        {
            await ApiClient.RenameNotebookAsync(authorId, renamingNotebookId.Value, renameValue.Trim());
            renamingNotebookId = null;
            renameValue = null;

            var response = await ApiClient.ListNotebooksAsync(authorId);
            notebooks = response?.Notebooks ?? [];
        }
        catch (HttpRequestException ex)
        {
            renameError = $"Failed to rename: {ex.Message}";
        }
        finally
        {
            isRenaming = false;
        }
    }

    // ===== Delete =====

    private void StartDelete(Guid notebookId)
    {
        deletingNotebookId = notebookId;
    }

    private void CancelDelete()
    {
        deletingNotebookId = null;
    }

    private async Task ConfirmDelete(Guid notebookId)
    {
        if (authorId == null) return;

        isDeleting = true;

        try
        {
            await ApiClient.DeleteNotebookAsync(authorId, notebookId);
            deletingNotebookId = null;

            var response = await ApiClient.ListNotebooksAsync(authorId);
            notebooks = response?.Notebooks ?? [];
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to delete notebook: {ex.Message}";
            deletingNotebookId = null;
        }
        finally
        {
            isDeleting = false;
        }
    }

    // ===== Connect =====

    private void ShowConnect(NotebookSummary nb)
    {
        if (authorId == null) return;

        CloseToken();
        connectNotebookId = nb.Id;
        connectNotebookName = nb.Name;
        connectToken = TokenService.GenerateToken(authorId);
        connectTarget = "claude";
        RegenerateConnectCommands();
    }

    private void OnTargetChanged(ChangeEventArgs e)
    {
        connectTarget = e.Value?.ToString() ?? "claude";
        RegenerateConnectCommands();
    }

    private void RegenerateConnectCommands()
    {
        if (connectNotebookId == null || connectToken == null) return;

        var baseUrl = Navigation.BaseUri.TrimEnd('/');
        var apiUrl = Configuration["NotebookApi:PublicUrl"] ?? baseUrl;
        var id = connectNotebookId.Value;
        var mcp = McpType;
        var targetSuffix = connectTarget != "claude" ? $" --target {connectTarget}" : "";
        var mcpSuffix = mcp != "notebook" ? $" --mcp {mcp}" : "";
        var psTargetSuffix = connectTarget != "claude" ? $" -Target '{connectTarget}'" : "";
        var psMcpSuffix = mcp != "notebook" ? $" -Mcp '{mcp}'" : "";

        bashCommand = $"curl -fsSL {baseUrl}/scripts/install.sh | bash -s -- {id} {connectToken} --url {apiUrl} --scripts-url {baseUrl}{targetSuffix}{mcpSuffix}";
        gitBashCommand = $"curl -fsSL {baseUrl}/scripts/install-gitbash.sh | bash -s -- {id} {connectToken} --url {apiUrl} --scripts-url {baseUrl}{targetSuffix}{mcpSuffix}";
        psCommand = $"iwr {baseUrl}/scripts/install.ps1 -OutFile $env:TEMP\\cyber-install.ps1; & $env:TEMP\\cyber-install.ps1 -NotebookId '{id}' -Token '{connectToken}' -Url '{apiUrl}' -ScriptsUrl '{baseUrl}'{psTargetSuffix}{psMcpSuffix}";
    }

    private void CloseConnect()
    {
        connectNotebookId = null;
        connectNotebookName = null;
        connectToken = null;
        connectTarget = "claude";
        bashCommand = null;
        gitBashCommand = null;
        psCommand = null;
    }

    // ===== Token =====

    private void ShowToken(NotebookSummary nb)
    {
        if (authorId == null) return;

        CloseConnect();
        tokenNotebookId = nb.Id;
        tokenNotebookName = nb.Name;
        tokenValue = TokenService.GenerateToken(authorId);
    }

    private void CloseToken()
    {
        tokenNotebookId = null;
        tokenNotebookName = null;
        tokenValue = null;
    }
}
