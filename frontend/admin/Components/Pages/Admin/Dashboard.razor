@page "/admin/dashboard"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject UserManager<ApplicationUser> UserManager
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

<h3>Dashboard</h3>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Users</h5>
                <p class="card-text display-4">@userCount</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success">
            <div class="card-body">
                <h5 class="card-title">Notebooks</h5>
                <p class="card-text display-4">@notebookCount</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-info">
            <div class="card-body">
                <h5 class="card-title">Total Entries</h5>
                <p class="card-text display-4">@totalEntries</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning">
            <div class="card-body">
                <h5 class="card-title">System Entropy</h5>
                <p class="card-text display-4">@systemEntropy.ToString("F1")</p>
            </div>
        </div>
    </div>
</div>

@if (apiError != null)
{
    <div class="alert alert-warning mt-3">
        Notebook API unreachable: @apiError
    </div>
}

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Recent Security Events</h6>
            </div>
            <div class="card-body p-0">
                @if (eventsError != null)
                {
                    <div class="alert alert-warning mb-0">@eventsError</div>
                }
                else if (securityEvents == null)
                {
                    <p class="p-3 mb-0 text-muted small">Loading...</p>
                }
                else if (securityEvents.Count == 0)
                {
                    <p class="p-3 mb-0 text-muted small">No access denied events.</p>
                }
                else
                {
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="font-size: 0.85rem;">When</th>
                                <th style="font-size: 0.85rem;">Actor</th>
                                <th style="font-size: 0.85rem;">Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var evt in securityEvents)
                            {
                                <tr>
                                    <td class="small text-muted">@evt.Timestamp.ToString("MM-dd HH:mm")</td>
                                    <td class="font-monospace small">@(evt.AuthorId?[..8] ?? "system")…</td>
                                    <td class="small">@evt.TargetType @(evt.TargetId?[..8] ?? "")…</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <p class="text-muted">
        The dashboard connects to the Rust notebook API for notebook statistics.
        Ensure the notebook server is running at the configured base URL.
    </p>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private int userCount;
    private int notebookCount;
    private long totalEntries;
    private double systemEntropy;
    private string? apiError;
    private string? authorIdHex;

    // Security events state
    private List<AuditLogEntryDto>? securityEvents;
    private string? eventsError;

    protected override async Task OnInitializedAsync()
    {
        userCount = await UserManager.Users.CountAsync();

        // Get current user's author ID
        var state = AuthState != null ? await AuthState : null;
        authorIdHex = await CurrentUser.GetAuthorIdHexAsync(state?.User);
        if (authorIdHex == null)
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        // Try to get notebook stats from the Rust API
        try
        {
            var response = await ApiClient.ListNotebooksAsync(authorIdHex);
            if (response != null)
            {
                notebookCount = response.Notebooks.Count;
                totalEntries = response.Notebooks.Sum(n => n.TotalEntries);
                systemEntropy = response.Notebooks.Sum(n => n.TotalEntropy);
            }
        }
        catch (Exception ex)
        {
            apiError = ex.Message;
        }

        // Load security events in parallel
        _ = LoadSecurityEventsAsync();
    }

    private async Task LoadSecurityEventsAsync()
    {
        try
        {
            // Query audit trail for recent access.denied events (last 10)
            var result = await ApiClient.QueryGlobalAuditAsync(
                authorIdHex!,
                action: "access.denied",
                limit: 10);
            securityEvents = result?.Entries ?? [];
        }
        catch (Exception ex)
        {
            eventsError = $"Could not load security events: {ex.Message}";
            securityEvents = [];
        }
    }
}
