@page "/admin/audit"
@layout AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.AspNetCore.Components.Authorization
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject AuditService AuditService
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Audit Log</PageTitle>

<h3>Audit Log & Reporting</h3>

@if (successMessage != null)
{
    <div class="alert alert-success alert-dismissible">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@if (errorMessage != null)
{
    <div class="alert alert-danger alert-dismissible">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

<!-- Filter Panel -->
<div class="card mb-3">
    <div class="card-header">
        <span>Advanced Filters</span>
        <button class="btn btn-sm btn-outline-secondary float-end" @onclick="ToggleFilters">
            @(showFilters ? "Hide" : "Show")
        </button>
    </div>

    @if (showFilters)
    {
        <div class="card-body">
            <div class="row g-3">
                <!-- Date Range -->
                <div class="col-md-2">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" @bind="filter.DateFrom" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" @bind="filter.DateTo" />
                </div>

                <!-- User/Actor -->
                <div class="col-md-3">
                    <label class="form-label">Actor (User)</label>
                    <input type="text" class="form-control" placeholder="Username or ID"
                           @bind="filter.ActorUsername" />
                </div>

                <!-- Action Type -->
                <div class="col-md-2">
                    <label class="form-label">Action</label>
                    <select class="form-select" @bind="filter.Action">
                        <option value="">All Actions</option>
                        <option value="Create">Create</option>
                        <option value="Update">Update</option>
                        <option value="Delete">Delete</option>
                        <option value="Lock">Lock</option>
                        <option value="Unlock">Unlock</option>
                        <option value="Login">Login</option>
                        <option value="Export">Export</option>
                        <option value="Import">Import</option>
                    </select>
                </div>

                <!-- Target Type -->
                <div class="col-md-2">
                    <label class="form-label">Target Type</label>
                    <select class="form-select" @bind="filter.TargetType">
                        <option value="">All Types</option>
                        <option value="User">User</option>
                        <option value="Notebook">Notebook</option>
                        <option value="Entry">Entry</option>
                        <option value="Organization">Organization</option>
                    </select>
                </div>

                <!-- Search -->
                <div class="col-md-3">
                    <label class="form-label">Search Details</label>
                    <input type="text" class="form-control" placeholder="Search in details..."
                           @bind="filter.SearchQuery" />
                </div>

                <!-- Page Size -->
                <div class="col-md-2">
                    <label class="form-label">Results Per Page</label>
                    <select class="form-select" @bind="filter.PageSize">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="250">250</option>
                    </select>
                </div>

                <!-- Sort -->
                <div class="col-md-2">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="filter.SortBy">
                        <option value="timestamp">Date</option>
                        <option value="action">Action</option>
                        <option value="actor">Actor</option>
                        <option value="target">Target</option>
                    </select>
                </div>

                <!-- Buttons -->
                <div class="col-12 mt-2">
                    <button class="btn btn-primary" @onclick="ApplyFilters" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Apply Filters")
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ResetFilters">
                        Reset
                    </button>
                    <button class="btn btn-outline-info" @onclick="ExportCsv" disabled="@isLoading">
                        Export CSV
                    </button>
                    <button class="btn btn-outline-info" @onclick="ExportJson" disabled="@isLoading">
                        Export JSON
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<!-- Stats Panel -->
@if (result != null)
{
    <div class="row mb-3">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-muted">Total Actions</h5>
                    <h3>@result.Stats.TotalActions</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-muted">Unique Actors</h5>
                    <h3>@result.Stats.UniqueActors</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-muted">Success Rate</h5>
                    <h3>@(result.Stats.TotalActions > 0 ? ((result.Stats.SuccessCount * 100) / result.Stats.TotalActions) : 0)%</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-muted">Most Common Action</h5>
                    <h3>@(result.Stats.MostCommonAction ?? "-")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-muted">Date Range</h5>
                    <small>@(result.Stats.EarliestEntry?.ToString("yyyy-MM-dd") ?? "-") to @(result.Stats.LatestEntry?.ToString("yyyy-MM-dd") ?? "-")</small>
                </div>
            </div>
        </div>
    </div>
}

<!-- Results Table -->
@if (result == null)
{
    <p class="text-muted">Load audit logs with filters above.</p>
}
else if (result.Entries.Count == 0)
{
    <div class="alert alert-info">No entries found matching the filters.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Actor</th>
                    <th>Action</th>
                    <th>Target</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in result.Entries)
                {
                    <tr>
                        <td class="text-muted small">@entry.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td><small>@(entry.AuthorId ?? "-")</small></td>
                        <td><span class="badge bg-info">@(entry.Action ?? "-")</span></td>
                        <td><small>@(entry.TargetType ?? "-"): @((entry.TargetId ?? "").Length > 8 ? entry.TargetId[..8] + "…" : entry.TargetId ?? "-")</small></td>
                        <td><small class="text-muted">@((entry.Detail?.ToString() ?? "-").Length > 50 ? (entry.Detail?.ToString() ?? "-")[..50] + "…" : entry.Detail?.ToString() ?? "-")</small></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (result.TotalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" disabled="@(filter.PageNumber == 0)">
                    <button class="page-link" @onclick="() => GoToPage(filter.PageNumber - 1)">Previous</button>
                </li>
                @for (int i = 0; i < result.TotalPages && i < 5; i++)
                {
                    var pageNum = i;
                    <li class="page-item" disabled="@(pageNum == filter.PageNumber)">
                        <button class="page-link" @onclick="() => GoToPage(pageNum)">@(pageNum + 1)</button>
                    </li>
                }
                @if (result.TotalPages > 5)
                {
                    <li class="page-item disabled"><span class="page-link">…</span></li>
                }
                <li class="page-item" disabled="@(filter.PageNumber >= result.TotalPages - 1)">
                    <button class="page-link" @onclick="() => GoToPage(filter.PageNumber + 1)">Next</button>
                </li>
            </ul>
        </nav>
        <p class="text-muted text-center">
            Page @(result.CurrentPage + 1) of @result.TotalPages
            (@result.Entries.Count of @result.TotalCount results shown)
        </p>
    }
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private AuditFilterModel filter = new();
    private AuditFilterResult? result;
    private bool showFilters = true;
    private bool isLoading = false;
    private string? successMessage;
    private string? errorMessage;
    private string? adminAuthorId;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState != null)
        {
            var authState = await AuthState;
            // Get admin's author ID
            adminAuthorId = authState.User.FindFirst("author_id")?.Value;
            if (string.IsNullOrEmpty(adminAuthorId))
            {
                adminAuthorId = await CurrentUser.GetAuthorIdHexAsync(authState.User);
            }
        }
    }

    private async Task ApplyFilters()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            if (adminAuthorId == null) return;
            filter.PageNumber = 0; // Reset to page 1 when applying new filters
            result = await AuditService.GetFilteredAuditAsync(adminAuthorId, filter);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading audit logs: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExportCsv()
    {
        isLoading = true;
        try
        {
            if (adminAuthorId == null) return;
            var csv = await AuditService.ExportAuditCsvAsync(adminAuthorId, filter);
            var timestamp = DateTime.UtcNow.ToString("yyyy-MM-dd_HHmmss");
            await JS.InvokeVoidAsync("triggerFileDownload", $"audit_export_{timestamp}.csv", csv);
            successMessage = "Audit log exported to CSV";
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExportJson()
    {
        isLoading = true;
        try
        {
            if (adminAuthorId == null) return;
            var json = await AuditService.ExportAuditJsonAsync(adminAuthorId, filter);
            var timestamp = DateTime.UtcNow.ToString("yyyy-MM-dd_HHmmss");
            await JS.InvokeVoidAsync("triggerFileDownload", $"audit_export_{timestamp}.json", json);
            successMessage = "Audit log exported to JSON";
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleFilters() => showFilters = !showFilters;

    private void ResetFilters()
    {
        filter = new();
        result = null;
    }

    private async Task GoToPage(int pageNum)
    {
        if (pageNum < 0 || pageNum >= (result?.TotalPages ?? 1)) return;
        filter.PageNumber = pageNum;
        await ApplyFilters();
    }
}
