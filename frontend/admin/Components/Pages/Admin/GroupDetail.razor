@page "/admin/groups/{GroupId:guid}"
@layout AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation

<PageTitle>@(groupName ?? "Group")</PageTitle>

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/organizations">Organizations</a></li>
        @if (orgId.HasValue)
        {
            <li class="breadcrumb-item"><a href="/admin/organizations/@orgId">@(orgName ?? orgId.ToString())</a></li>
        }
        <li class="breadcrumb-item active">@(groupName ?? GroupId.ToString())</li>
    </ol>
</nav>

<h3>@(groupName ?? "Group")</h3>

@if (errorMessage != null)
{
    <div class="alert alert-warning">@errorMessage</div>
}

@if (members == null && errorMessage == null)
{
    <p>Loading...</p>
}
else
{
    <!-- Members Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Members</h5>

            @if (members != null && members.Count == 0)
            {
                <p class="text-muted">No members yet.</p>
            }
            else if (members != null)
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Role</th>
                            <th>Granted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var member in members)
                        {
                            <tr>
                                <td>
                                    <NotebookAdmin.Components.Shared.AuthorDisplay AuthorIdHex="@member.AuthorId" />
                                </td>
                                <td>
                                    <span class="badge @(member.Role == "admin" ? "bg-warning text-dark" : "bg-secondary")">
                                        @member.Role
                                    </span>
                                </td>
                                <td>@member.Granted.ToString("yyyy-MM-dd")</td>
                                <td>
                                    @if (removingMember == member.AuthorId)
                                    {
                                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmRemoveMember(member.AuthorId)"
                                                disabled="@isSubmitting">Yes, Remove</button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1"
                                                @onclick="() => removingMember = null">Cancel</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-danger"
                                                @onclick="() => removingMember = member.AuthorId"
                                                disabled="@isSubmitting">Remove</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h6 class="mt-3">Add Member</h6>
            <div class="row g-2">
                <div class="col-md-5">
                    <input class="form-control font-monospace" placeholder="Author ID (64 hex chars)"
                           @bind="newMemberAuthorId" @bind:event="oninput"
                           disabled="@isSubmitting" />
                    @if (memberIdError != null)
                    {
                        <div class="text-danger small">@memberIdError</div>
                    }
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="newMemberRole" disabled="@isSubmitting">
                        <option value="member">member</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary" @onclick="AddMember"
                            disabled="@(isSubmitting || string.IsNullOrWhiteSpace(newMemberAuthorId))">
                        Add Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notebooks Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Owned Notebooks</h5>

            @if (ownedNotebooks == null)
            {
                <p>Loading notebooks...</p>
            }
            else if (ownedNotebooks.Count == 0)
            {
                <p class="text-muted">No notebooks assigned to this group.</p>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Entries</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var nb in ownedNotebooks)
                        {
                            <tr>
                                <td><a href="/notebooks/@nb.Id">@nb.Name</a></td>
                                <td>@nb.TotalEntries</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => UnassignNotebook(nb.Id)"
                                            disabled="@isSubmitting">Unassign</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h6 class="mt-3">Assign Notebook to this Group</h6>
            <div class="row g-2">
                <div class="col-md-6">
                    <select class="form-select" @bind="assignNotebookId" disabled="@isSubmitting">
                        <option value="">— Select notebook —</option>
                        @if (allNotebooks != null)
                        {
                            @foreach (var nb in allNotebooks.Where(n => !ownedNotebooks?.Any(o => o.Id == n.Id) ?? true))
                            {
                                <option value="@nb.Id">@nb.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-primary" @onclick="AssignNotebook"
                            disabled="@(isSubmitting || string.IsNullOrEmpty(assignNotebookId))">
                        Assign
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid GroupId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private string? authorId;
    private string? groupName;
    private Guid? orgId;
    private string? orgName;
    private List<MemberResponse>? members;
    private List<NotebookSummary>? ownedNotebooks;
    private List<NotebookSummary>? allNotebooks;
    private string? errorMessage;
    private bool isSubmitting;

    private string newMemberAuthorId = string.Empty;
    private string newMemberRole = "member";
    private string? memberIdError;
    private string? removingMember;
    private string assignNotebookId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var state = AuthState != null ? await AuthState : null;
        authorId = await CurrentUser.GetAuthorIdHexAsync(state?.User);
        if (authorId == null) { Navigation.NavigateTo("/auth/login"); return; }

        await Task.WhenAll(LoadGroupInfo(), LoadMembers(), LoadNotebooks());
    }

    private async Task LoadGroupInfo()
    {
        try
        {
            var orgsResult = await ApiClient.ListOrganizationsAsync(authorId!);
            if (orgsResult == null) return;

            foreach (var org in orgsResult.Organizations)
            {
                var groupsResult = await ApiClient.ListGroupsAsync(authorId!, org.Id);
                var group = groupsResult?.Groups.FirstOrDefault(g => g.Id == GroupId);
                if (group != null)
                {
                    groupName = group.Name;
                    orgId = org.Id;
                    orgName = org.Name;
                    return;
                }
            }
        }
        catch { /* group name is decorative */ }
    }

    private async Task LoadMembers()
    {
        try
        {
            var result = await ApiClient.ListMembersAsync(authorId!, GroupId);
            members = result?.Members ?? [];
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to load members: {ex.Message}";
        }
    }

    private async Task LoadNotebooks()
    {
        try
        {
            var result = await ApiClient.ListNotebooksAsync(authorId!);
            allNotebooks = result?.Notebooks ?? [];
            // Filter to notebooks owned by this group (owning_group_id not in current model,
            // so we rely on assignment flow; show all notebooks as "owned" if they were assigned)
            ownedNotebooks = [];
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to load notebooks: {ex.Message}";
        }
    }

    private bool ValidateAuthorId(string hex)
    {
        if (hex.Length != 64) return false;
        return hex.All(c => (c >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F'));
    }

    private async Task AddMember()
    {
        memberIdError = null;
        var normalized = newMemberAuthorId.Trim().ToLowerInvariant();
        if (!ValidateAuthorId(normalized))
        {
            memberIdError = "Author ID must be exactly 64 hex characters.";
            return;
        }
        isSubmitting = true;
        try
        {
            await ApiClient.AddMemberAsync(authorId!, GroupId, normalized, newMemberRole);
            newMemberAuthorId = string.Empty;
            newMemberRole = "member";
            await LoadMembers();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to add member: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task ConfirmRemoveMember(string memberAuthorId)
    {
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.RemoveMemberAsync(authorId!, GroupId, memberAuthorId);
            removingMember = null;
            await LoadMembers();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to remove member: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task AssignNotebook()
    {
        if (!Guid.TryParse(assignNotebookId, out var notebookId)) return;
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.AssignNotebookToGroupAsync(authorId!, notebookId, GroupId);
            assignNotebookId = string.Empty;
            await LoadNotebooks();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to assign notebook: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task UnassignNotebook(Guid notebookId)
    {
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.AssignNotebookToGroupAsync(authorId!, notebookId, null);
            await LoadNotebooks();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to unassign notebook: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }
}
