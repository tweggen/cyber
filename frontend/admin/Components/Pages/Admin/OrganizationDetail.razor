@page "/admin/organizations/{OrgId:guid}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using NotebookAdmin.Models
@using NotebookAdmin.Services
@inject NotebookApiClient ApiClient
@inject CurrentUserService CurrentUser
@inject NavigationManager Navigation

<PageTitle>@(orgName ?? "Organization")</PageTitle>

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/organizations">Organizations</a></li>
        <li class="breadcrumb-item active">@(orgName ?? OrgId.ToString())</li>
    </ol>
</nav>

<h3>@(orgName ?? "Organization")</h3>

@if (errorMessage != null)
{
    <div class="alert alert-warning">@errorMessage</div>
}

@if (groupsData == null && errorMessage == null)
{
    <p>Loading...</p>
}
else if (groupsData != null)
{
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Groups</h5>

                    @if (rootGroups.Count == 0)
                    {
                        <p class="text-muted">No groups yet.</p>
                    }
                    else
                    {
                        <div class="group-tree">
                            @foreach (var root in rootGroups)
                            {
                                @RenderGroupNode(root, 0)
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Create Group</h5>
            <div class="row g-2">
                <div class="col-md-4">
                    <input class="form-control" placeholder="Group name"
                           @bind="newGroupName" @bind:event="oninput"
                           disabled="@isSubmitting" />
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="newGroupParentId" disabled="@isSubmitting">
                        <option value="">— No parent (root group) —</option>
                        @foreach (var g in groupsData.Groups)
                        {
                            <option value="@g.Id">@g.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary" @onclick="CreateGroup"
                            disabled="@(isSubmitting || string.IsNullOrWhiteSpace(newGroupName))">
                        @(isSubmitting ? "Creating..." : "Create Group")
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Add Edge (parent → child relationship)</h5>
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Parent Group</label>
                    <select class="form-select" @bind="edgeParentId" disabled="@isSubmitting">
                        <option value="">— Select parent —</option>
                        @foreach (var g in groupsData.Groups)
                        {
                            <option value="@g.Id">@g.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Child Group</label>
                    <select class="form-select" @bind="edgeChildId" disabled="@isSubmitting">
                        <option value="">— Select child —</option>
                        @foreach (var g in groupsData.Groups)
                        {
                            <option value="@g.Id">@g.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-primary" @onclick="AddEdge"
                            disabled="@(isSubmitting || string.IsNullOrEmpty(edgeParentId) || string.IsNullOrEmpty(edgeChildId))">
                        Add Edge
                    </button>
                </div>
            </div>

            @if (groupsData.Edges.Count > 0)
            {
                <table class="table table-sm mt-3">
                    <thead>
                        <tr><th>Parent</th><th>Child</th><th></th></tr>
                    </thead>
                    <tbody>
                        @foreach (var edge in groupsData.Edges)
                        {
                            var parent = groupsData.Groups.FirstOrDefault(g => g.Id == edge.ParentId);
                            var child = groupsData.Groups.FirstOrDefault(g => g.Id == edge.ChildId);
                            <tr>
                                <td>@(parent?.Name ?? edge.ParentId.ToString())</td>
                                <td>@(child?.Name ?? edge.ChildId.ToString())</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => RemoveEdge(edge.ParentId, edge.ChildId)"
                                            disabled="@isSubmitting">Remove</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Security Clearances</h5>

            @if (clearances == null)
            {
                <p>Loading clearances...</p>
            }
            else if (clearances.Count == 0)
            {
                <p class="text-muted">No clearances granted for this organization.</p>
            }
            else
            {
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Max Level</th>
                            <th>Compartments</th>
                            <th>Granted</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in clearances)
                        {
                            <tr>
                                <td><NotebookAdmin.Components.Shared.AuthorDisplay AuthorIdHex="@c.AuthorId" /></td>
                                <td><span class="badge bg-secondary">@c.MaxLevel</span></td>
                                <td>@(c.Compartments.Count > 0 ? string.Join(", ", c.Compartments) : "—")</td>
                                <td>@c.Granted.ToString("yyyy-MM-dd")</td>
                                <td>
                                    @if (revokingClearance == c.AuthorId)
                                    {
                                        <button class="btn btn-sm btn-danger"
                                                @onclick="() => ConfirmRevokeClearance(c.AuthorId)"
                                                disabled="@isSubmitting">Yes, Revoke</button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1"
                                                @onclick="() => revokingClearance = null">Cancel</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-danger"
                                                @onclick="() => revokingClearance = c.AuthorId"
                                                disabled="@isSubmitting">Revoke</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <h6 class="mt-3">Grant Clearance</h6>
            <div class="row g-2">
                <div class="col-md-4">
                    <input class="form-control font-monospace" placeholder="Author ID (64 hex chars)"
                           @bind="clearanceAuthorId" @bind:event="oninput"
                           disabled="@isSubmitting" />
                    @if (clearanceAuthorIdError != null)
                    {
                        <div class="text-danger small">@clearanceAuthorIdError</div>
                    }
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="clearanceMaxLevel" disabled="@isSubmitting">
                        <option value="PUBLIC">PUBLIC</option>
                        <option value="INTERNAL" selected>INTERNAL</option>
                        <option value="CONFIDENTIAL">CONFIDENTIAL</option>
                        <option value="SECRET">SECRET</option>
                        <option value="TOP_SECRET">TOP_SECRET</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input class="form-control" placeholder="Compartments (comma-separated)"
                           @bind="clearanceCompartments" @bind:event="oninput"
                           disabled="@isSubmitting" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" @onclick="GrantClearance"
                            disabled="@(isSubmitting || string.IsNullOrWhiteSpace(clearanceAuthorId))">
                        Grant
                    </button>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary" @onclick="FlushCache"
                        disabled="@isSubmitting" title="Flush clearance cache on the server">
                    Flush Cache
                </button>
                @if (cacheFlushMessage != null)
                {
                    <span class="ms-2 text-success small">@cacheFlushMessage</span>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid OrgId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private string? authorId;
    private string? orgName;
    private ListGroupsResponse? groupsData;
    private string? errorMessage;
    private bool isSubmitting;

    private string newGroupName = string.Empty;
    private string newGroupParentId = string.Empty;
    private string edgeParentId = string.Empty;
    private string edgeChildId = string.Empty;

    // Clearance state
    private List<ClearanceSummaryResponse>? clearances;
    private string clearanceAuthorId = string.Empty;
    private string clearanceMaxLevel = "INTERNAL";
    private string clearanceCompartments = string.Empty;
    private string? clearanceAuthorIdError;
    private string? revokingClearance;
    private string? cacheFlushMessage;

    private List<GroupResponse> rootGroups = [];
    private Dictionary<Guid, List<GroupResponse>> childMap = new();
    private HashSet<Guid> expandedGroups = new();

    protected override async Task OnInitializedAsync()
    {
        var state = AuthState != null ? await AuthState : null;
        authorId = await CurrentUser.GetAuthorIdHexAsync(state?.User);
        if (authorId == null) { Navigation.NavigateTo("/auth/login"); return; }

        await LoadOrgs();
        await Task.WhenAll(LoadGroups(), LoadClearances());
    }

    private async Task LoadOrgs()
    {
        try
        {
            var result = await ApiClient.ListOrganizationsAsync(authorId!);
            orgName = result?.Organizations.FirstOrDefault(o => o.Id == OrgId)?.Name;
        }
        catch { /* org name is decorative */ }
    }

    private async Task LoadGroups()
    {
        try
        {
            groupsData = await ApiClient.ListGroupsAsync(authorId!, OrgId);
            RebuildTree();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"API error: {ex.Message}";
        }
    }

    private void RebuildTree()
    {
        if (groupsData == null) return;
        childMap = new Dictionary<Guid, List<GroupResponse>>();
        var childIds = new HashSet<Guid>(groupsData.Edges.Select(e => e.ChildId));

        foreach (var edge in groupsData.Edges)
        {
            if (!childMap.ContainsKey(edge.ParentId))
                childMap[edge.ParentId] = [];
            var child = groupsData.Groups.FirstOrDefault(g => g.Id == edge.ChildId);
            if (child != null)
                childMap[edge.ParentId].Add(child);
        }

        rootGroups = groupsData.Groups.Where(g => !childIds.Contains(g.Id)).ToList();
    }

    private RenderFragment RenderGroupNode(GroupResponse group, int level) => builder =>
    {
        var children = childMap.GetValueOrDefault(group.Id, []);
        var isExpanded = expandedGroups.Contains(group.Id);

        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "style", $"padding-left: {level * 20}px; margin-bottom: 4px;");

        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "d-flex align-items-center gap-2");

        if (children.Count > 0)
        {
            builder.OpenElement(4, "button");
            builder.AddAttribute(5, "class", "btn btn-sm btn-link p-0");
            builder.AddAttribute(6, "onclick", EventCallback.Factory.Create(this, () => ToggleExpand(group.Id)));
            builder.AddContent(7, isExpanded ? "▼" : "▶");
            builder.CloseElement();
        }
        else
        {
            builder.OpenElement(8, "span");
            builder.AddAttribute(9, "style", "width: 24px; display: inline-block;");
            builder.AddContent(10, "•");
            builder.CloseElement();
        }

        builder.OpenElement(11, "a");
        builder.AddAttribute(12, "href", $"/admin/groups/{group.Id}");
        builder.AddContent(13, group.Name);
        builder.CloseElement();

        builder.OpenElement(14, "span");
        builder.AddAttribute(15, "class", "text-muted small");
        builder.AddContent(16, $"(created {group.Created:yyyy-MM-dd})");
        builder.CloseElement();

        builder.CloseElement(); // d-flex

        if (isExpanded && children.Count > 0)
        {
            foreach (var child in children)
            {
                builder.AddContent(17, RenderGroupNode(child, level + 1));
            }
        }

        builder.CloseElement(); // outer div
    };

    private void ToggleExpand(Guid groupId)
    {
        if (!expandedGroups.Add(groupId))
            expandedGroups.Remove(groupId);
    }

    private async Task CreateGroup()
    {
        if (string.IsNullOrWhiteSpace(newGroupName)) return;
        isSubmitting = true;
        errorMessage = null;
        try
        {
            Guid? parentId = Guid.TryParse(newGroupParentId, out var pid) ? pid : null;
            await ApiClient.CreateGroupAsync(authorId!, OrgId, newGroupName.Trim(), parentId);
            newGroupName = string.Empty;
            newGroupParentId = string.Empty;
            await LoadGroups();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to create group: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task AddEdge()
    {
        if (!Guid.TryParse(edgeParentId, out var parentId) || !Guid.TryParse(edgeChildId, out var childId)) return;
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.AddEdgeAsync(authorId!, OrgId, parentId, childId);
            edgeParentId = string.Empty;
            edgeChildId = string.Empty;
            await LoadGroups();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to add edge: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task RemoveEdge(Guid parentId, Guid childId)
    {
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.RemoveEdgeAsync(authorId!, parentId, childId);
            await LoadGroups();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to remove edge: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task LoadClearances()
    {
        try
        {
            var result = await ApiClient.ListClearancesAsync(authorId!, OrgId);
            clearances = result?.Clearances ?? [];
        }
        catch (HttpRequestException)
        {
            clearances = [];
        }
    }

    private bool ValidateAuthorHex(string hex) =>
        hex.Length == 64 && hex.All(c =>
            (c >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F'));

    private async Task GrantClearance()
    {
        clearanceAuthorIdError = null;
        var normalized = clearanceAuthorId.Trim().ToLowerInvariant();
        if (!ValidateAuthorHex(normalized))
        {
            clearanceAuthorIdError = "Author ID must be exactly 64 hex characters.";
            return;
        }
        isSubmitting = true;
        errorMessage = null;
        try
        {
            var compartments = clearanceCompartments
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
            await ApiClient.GrantClearanceAsync(authorId!, normalized, OrgId, clearanceMaxLevel, compartments);
            clearanceAuthorId = string.Empty;
            clearanceCompartments = string.Empty;
            clearanceMaxLevel = "INTERNAL";
            await LoadClearances();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to grant clearance: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task ConfirmRevokeClearance(string targetAuthorId)
    {
        isSubmitting = true;
        errorMessage = null;
        try
        {
            await ApiClient.RevokeClearanceAsync(authorId!, targetAuthorId, OrgId);
            revokingClearance = null;
            await LoadClearances();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to revoke clearance: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }

    private async Task FlushCache()
    {
        isSubmitting = true;
        cacheFlushMessage = null;
        try
        {
            await ApiClient.FlushClearanceCacheAsync(authorId!);
            cacheFlushMessage = "Cache flushed.";
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to flush cache: {ex.Message}";
        }
        finally { isSubmitting = false; }
    }
}
